<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Studio | Tony Reviews Things</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6b6b;
            --primary-dark: #ee5a5a;
            --secondary: #4ecdc4;
            --dark: #2d3436;
            --light: #f8f9fa;
            --gray: #94a0a4;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #ff7675;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        header { text-align: center; padding: 30px 0; }
        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .tagline { color: var(--gray); font-size: 1.05rem; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray); }

        input, textarea, select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); }
        textarea { min-height: 110px; resize: vertical; }

        .btn { padding: 12px 18px; border: none; border-radius: 12px; font-size: .95rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-secondary { background: rgba(255,255,255,.1); color: white; border: 2px solid rgba(255,255,255,.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .star-rating { display: flex; flex-direction: row-reverse; gap: 8px; }
        .star-rating input { display: none; }
        .star-rating label { cursor: pointer; font-size: 2rem; color: rgba(255,255,255,.3); }
        .star-rating label:hover, .star-rating label:hover ~ label, .star-rating input:checked ~ label { color: #ffd700; }

        .pros-cons {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 12px;
        }
        @media (max-width: 640px) {
            .pros-cons { grid-template-columns: 1fr; }
            .add-item { flex-wrap: wrap; }
            .add-item input { min-width: 0; }
        }

        .pro-con-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255,255,255,.05);
            border-radius: 10px;
            margin-bottom: 8px;
            word-break: break-word;
        }
        .pro-con-text { overflow-wrap: anywhere; }
        .pro-con-item.pro { border-left: 3px solid var(--success); }
        .pro-con-item.con { border-left: 3px solid var(--danger); }
        .pro-con-item button { background: none; border: none; color: var(--gray); cursor: pointer; font-size: 1.1rem; }

        .add-item { display: flex; gap: 8px; }
        .add-item input { flex: 1; }

        .ai-suggestions {
            background: linear-gradient(135deg, rgba(78,205,196,.1), rgba(255,107,107,.1));
            border-radius: 15px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }
        .ai-badge { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, var(--secondary), #26de81); color: #fff; padding: 5px 11px; border-radius: 20px; font-size: .8rem; font-weight: 600; margin-bottom: 10px; }
        .suggestion-item { padding: 10px; background: rgba(255,255,255,.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }

        .preview { background: #fff; color: #333; border-radius: 15px; padding: 24px; min-height: 360px; }
        .preview-header { border-bottom: 2px solid #eee; padding-bottom: 16px; margin-bottom: 16px; }
        .preview-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 8px; }
        .preview-rating { color: #ffd700; font-size: 1.4rem; letter-spacing: 2px; }
        .preview-category { display: inline-block; background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-top: 8px; }

        .preview-pros, .preview-cons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .preview-pros span { background: rgba(0,184,148,.1); color: var(--success); padding: 5px 10px; border-radius: 20px; font-size: .88rem; }
        .preview-cons span { background: rgba(255,107,107,.1); color: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: .88rem; }

        .export-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 18px; }
        .full-width { grid-column: 1 / -1; }

        .toast-wrap {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: rgba(0,0,0,.85);
            color: #fff;
            border: 1px solid rgba(255,255,255,.2);
            border-radius: 10px;
            padding: 10px 12px;
            min-width: 220px;
        }
        .toast.success { border-color: rgba(0,184,148,.6); }
        .toast.error { border-color: rgba(255,118,117,.6); }

        .login-gate {
            max-width: 420px;
            margin: 10vh auto;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255,255,255,.2);
            border-radius: 16px;
            padding: 24px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="toast-wrap" id="toastWrap"></div>

    <div class="login-gate hidden" id="loginGate">
        <h2 style="margin-bottom:12px;">üîê Private Access</h2>
        <p style="margin-bottom:14px;color:#dfe6e9;">Enter password to access caption studio.</p>
        <input id="passwordInput" type="password" placeholder="Password" autocomplete="current-password">
        <button class="btn btn-primary" id="loginBtn" style="margin-top:12px;width:100%;justify-content:center;">Sign in</button>
    </div>

    <div class="container hidden" id="appRoot">
        <header>
            <div class="logo">üé¨ Review Studio</div>
            <p class="tagline">AI-Powered Review Creation for Tony Reviews Things</p>
        </header>

        <div class="main-grid">
            <div class="card">
                <div class="card-title">üìù Product Details</div>
                <div class="form-group"><label>Product Name</label><input type="text" id="productName" placeholder="e.g., Sony WH-1000XM5 Headphones"></div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option value="">Select category...</option>
                        <option value="tech">Tech & Gadgets</option><option value="audio">Audio</option><option value="gaming">Gaming</option><option value="home">Home & Living</option>
                        <option value="fashion">Fashion</option><option value="food">Food & Drinks</option><option value="software">Software & Apps</option><option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Your Rating (optional)</label>
                    <div class="star-rating">
                        <input type="radio" name="rating" value="5" id="star5"><label for="star5">‚òÖ</label>
                        <input type="radio" name="rating" value="4" id="star4"><label for="star4">‚òÖ</label>
                        <input type="radio" name="rating" value="3" id="star3"><label for="star3">‚òÖ</label>
                        <input type="radio" name="rating" value="2" id="star2"><label for="star2">‚òÖ</label>
                        <input type="radio" name="rating" value="1" id="star1"><label for="star1">‚òÖ</label>
                    </div>
                </div>
                <div class="form-group"><label>Key Features (comma-separated)</label><input type="text" id="features" placeholder="noise cancellation, 30hr battery, premium sound"></div>
            </div>

            <div class="card">
                <div class="card-title">‚öñÔ∏è Pros & Cons</div>
                <div class="pros-cons">
                    <div>
                        <label style="color: var(--success);">‚úì Pros</label>
                        <div id="prosList"></div>
                        <div class="add-item"><input type="text" id="proInput" placeholder="Add a pro..."><button class="btn btn-secondary" id="addProBtn" type="button">+</button></div>
                    </div>
                    <div>
                        <label style="color: var(--primary);">‚úó Cons</label>
                        <div id="consList"></div>
                        <div class="add-item"><input type="text" id="conInput" placeholder="Add a con..."><button class="btn btn-secondary" id="addConBtn" type="button">+</button></div>
                    </div>
                </div>

                <div class="ai-suggestions" id="aiSection">
                    <div class="ai-badge">ü§ñ Gemini Suggestions</div>
                    <div id="suggestions"></div>
                </div>
                <button class="btn btn-primary" id="aiBtn" style="margin-top: 14px; width: 100%; justify-content:center;" type="button">‚ú® Get AI Suggestions</button>
            </div>

            <div class="card full-width">
                <div class="card-title">üìÑ Your Review</div>
                <div class="form-group"><label>Review Summary (hook)</label><input type="text" id="summary" placeholder="A catchy opening that grabs attention..."></div>
                <div class="form-group"><label>Detailed Review</label><textarea id="reviewBody" placeholder="Write your in-depth review here..."></textarea></div>
                <div class="form-group"><label>Final Verdict</label><textarea id="verdict" placeholder="Your final thoughts and recommendation..." style="min-height: 80px;"></textarea></div>
            </div>

            <div class="card full-width">
                <div class="card-title">üëÅÔ∏è Live Preview</div>
                <div class="preview" id="preview">
                    <div class="preview-header">
                        <div class="preview-title" id="previewTitle">Your Product Name</div>
                        <div class="preview-rating" id="previewRating">No rating yet</div>
                        <span class="preview-category" id="previewCategory">Uncategorized</span>
                    </div>
                    <div class="preview-section" id="previewSummarySection" style="display:none;"><h3>Summary</h3><p id="previewSummary"></p></div>
                    <div class="preview-section" id="previewProsCons" style="display:none;"><h3>Pros & Cons</h3><div class="preview-pros" id="previewPros"></div><div class="preview-cons" id="previewCons"></div></div>
                    <div class="preview-section" id="previewBodySection" style="display:none;"><h3>The Review</h3><div class="preview-body" id="previewBodyText"></div></div>
                    <div class="preview-section" id="previewVerdictSection" style="display:none;"><h3>Verdict</h3><p id="previewVerdictText"></p></div>
                </div>

                <div class="export-options">
                    <button class="btn btn-secondary" id="copyBtn" type="button">üìã Copy to Clipboard</button>
                    <button class="btn btn-secondary" id="downloadTxtBtn" type="button">üì• Download .txt</button>
                    <button class="btn btn-secondary" id="downloadMdBtn" type="button">üìù Download .md</button>
                    <button class="btn btn-primary" id="socialBtn" type="button">üê¶ Social Media Version</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state = { pros: [], cons: [] };

        const q = (id) => document.getElementById(id);
        const escapeEmoji = (s) => s.replace(/[üéØüí°‚úÖ‚ùåü§î]/g, '').trim();

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            q('toastWrap').appendChild(toast);
            setTimeout(() => toast.remove(), 3200);
        }

        async function checkSession() {
            try {
                const res = await fetch('/api/auth/session', { credentials: 'include' });
                if (res.ok) {
                    q('appRoot').classList.remove('hidden');
                    return;
                }
            } catch (_) {}
            q('loginGate').classList.remove('hidden');
        }

        async function login() {
            const password = q('passwordInput').value;
            if (!password) return showToast('Password required', 'error');
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ password })
                });
                if (!res.ok) throw new Error('Invalid password');
                q('loginGate').classList.add('hidden');
                q('appRoot').classList.remove('hidden');
                q('passwordInput').value = '';
                showToast('Signed in');
            } catch (err) {
                showToast(err.message || 'Sign in failed', 'error');
            }
        }

        function renderList(items, containerId, type) {
            const container = q(containerId);
            container.replaceChildren();
            items.forEach((text, index) => {
                const row = document.createElement('div');
                row.className = `pro-con-item ${type}`;
                const span = document.createElement('span');
                span.className = 'pro-con-text';
                span.textContent = `${type === 'pro' ? '‚úì' : '‚úó'} ${text}`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '√ó';
                btn.setAttribute('aria-label', `Remove ${type}`);
                btn.addEventListener('click', () => {
                    if (type === 'pro') state.pros.splice(index, 1);
                    else state.cons.splice(index, 1);
                    renderProsCons();
                    updatePreview();
                });
                row.append(span, btn);
                container.appendChild(row);
            });
        }

        function renderProsCons() {
            renderList(state.pros, 'prosList', 'pro');
            renderList(state.cons, 'consList', 'con');
        }

        function getRatingData() {
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const rating = ratingEl ? Number(ratingEl.value) : null;
            return { rating, stars: rating ? `${'‚òÖ'.repeat(rating)}${'‚òÜ'.repeat(5 - rating)}` : 'No rating yet' };
        }

        function selectedCategoryText() {
            const category = q('category');
            const value = category.value;
            if (!value) return '';
            return category.options[category.selectedIndex]?.text || '';
        }

        function updatePreview() {
            q('previewTitle').textContent = q('productName').value || 'Your Product Name';
            const { stars } = getRatingData();
            q('previewRating').textContent = stars;

            const categoryText = selectedCategoryText() || 'Uncategorized';
            q('previewCategory').textContent = categoryText;

            const summary = q('summary').value.trim();
            q('previewSummarySection').style.display = summary ? 'block' : 'none';
            q('previewSummary').textContent = summary;

            const hasProsCons = state.pros.length > 0 || state.cons.length > 0;
            q('previewProsCons').style.display = hasProsCons ? 'block' : 'none';

            const previewPros = q('previewPros');
            previewPros.replaceChildren();
            state.pros.forEach((p) => {
                const span = document.createElement('span');
                span.textContent = `‚úì ${p}`;
                previewPros.appendChild(span);
            });

            const previewCons = q('previewCons');
            previewCons.replaceChildren();
            state.cons.forEach((c) => {
                const span = document.createElement('span');
                span.textContent = `‚úó ${c}`;
                previewCons.appendChild(span);
            });

            const body = q('reviewBody').value.trim();
            q('previewBodySection').style.display = body ? 'block' : 'none';
            q('previewBodyText').textContent = body;

            const verdict = q('verdict').value.trim();
            q('previewVerdictSection').style.display = verdict ? 'block' : 'none';
            q('previewVerdictText').textContent = verdict;
        }

        function appendSuggestion(text) {
            const clean = escapeEmoji(text);
            const current = q('reviewBody').value.trim();
            q('reviewBody').value = `${current}${current ? '\n\n' : ''}${clean}: \n`;
            q('reviewBody').focus();
            updatePreview();
        }

        async function generateSuggestions() {
            q('aiBtn').disabled = true;
            q('aiSection').style.display = 'block';
            const suggestions = q('suggestions');
            suggestions.textContent = 'ü§ñ Gemini is thinking...';

            const payload = {
                category: q('category').value || 'other',
                productName: q('productName').value.trim(),
                features: q('features').value.trim()
            };

            try {
                const res = await fetch('/api/ai/suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Could not generate suggestions');

                suggestions.replaceChildren();
                data.suggestions.forEach((s) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = s;
                    item.addEventListener('click', () => appendSuggestion(s));
                    suggestions.appendChild(item);
                });

                if (!q('reviewBody').value.trim() && data.suggestions.length) {
                    q('reviewBody').value = data.suggestions.slice(0, 3).map(escapeEmoji).join('\n\n');
                }
                updatePreview();
                showToast('Suggestions ready');
            } catch (err) {
                suggestions.textContent = 'Could not load suggestions.';
                showToast(err.message || 'Suggestion generation failed', 'error');
            } finally {
                q('aiBtn').disabled = false;
            }
        }

        function generateFullReview() {
            const name = q('productName').value.trim() || 'Product';
            const { rating, stars } = getRatingData();
            const category = selectedCategoryText();
            const summary = q('summary').value.trim();
            const body = q('reviewBody').value.trim();
            const verdict = q('verdict').value.trim();

            let out = `${name} Review\n${'='.repeat(name.length + 8)}\n\n`;
            out += rating ? `Rating: ${stars} (${rating}/5)\n` : 'Rating: Not rated\n';
            if (category) out += `Category: ${category}\n`;
            out += '\n';

            if (summary) out += `SUMMARY\n-------\n${summary}\n\n`;

            if (state.pros.length || state.cons.length) {
                out += 'PROS & CONS\n-----------\n';
                if (state.pros.length) {
                    out += 'Pros:\n';
                    state.pros.forEach((p) => { out += `  ‚úì ${p}\n`; });
                }
                if (state.cons.length) {
                    out += '\nCons:\n';
                    state.cons.forEach((c) => { out += `  ‚úó ${c}\n`; });
                }
                out += '\n';
            }

            if (body) out += `THE REVIEW\n----------\n${body}\n\n`;
            if (verdict) out += `VERDICT\n-------\n${verdict}\n`;
            return out;
        }

        function generateMarkdown() {
            const name = q('productName').value.trim() || 'Product';
            const { rating, stars } = getRatingData();
            const category = selectedCategoryText();
            const summary = q('summary').value.trim();
            const body = q('reviewBody').value.trim();
            const verdict = q('verdict').value.trim();

            let md = `# ${name} Review\n\n`;
            md += rating ? `**Rating:** ${stars} (${rating}/5)\n` : '**Rating:** Not rated\n';
            if (category) md += `**Category:** ${category}\n`;
            md += '\n---\n\n';
            if (summary) md += `## Summary\n\n${summary}\n\n`;
            if (state.pros.length || state.cons.length) {
                md += '## Pros & Cons\n\n';
                if (state.pros.length) md += `### ‚úÖ Pros\n${state.pros.map((p) => `- ${p}`).join('\n')}\n\n`;
                if (state.cons.length) md += `### ‚ùå Cons\n${state.cons.map((c) => `- ${c}`).join('\n')}\n\n`;
            }
            if (body) md += `## The Review\n\n${body}\n\n`;
            if (verdict) md += `## Verdict\n\n${verdict}\n\n`;
            md += '---\n*Review by Tony Reviews Things*';
            return md;
        }

        function download(content, ext, type) {
            const name = (q('productName').value.trim() || 'review').replace(/[^a-z0-9-_]/gi, '_').toLowerCase();
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.${ext}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function copyTextWithFallback(text) {
            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
            } catch (_) {}

            const temp = document.createElement('textarea');
            temp.value = text;
            temp.style.position = 'fixed';
            temp.style.opacity = '0';
            document.body.appendChild(temp);
            temp.select();
            try {
                const ok = document.execCommand('copy');
                temp.remove();
                return ok;
            } catch (_) {
                temp.remove();
                return false;
            }
        }

        async function copyReview() {
            const ok = await copyTextWithFallback(generateFullReview());
            showToast(ok ? 'Review copied' : 'Copy failed. Try manual copy.', ok ? 'success' : 'error');
        }

        async function copyForSocial() {
            const { rating, stars } = getRatingData();
            const name = q('productName').value.trim() || 'This product';
            const summary = q('summary').value.trim();
            let text = `üì± ${name} Review\n\n`;
            text += `${rating ? stars : 'No rating yet'}\n\n`;
            if (summary) text += `${summary}\n\n`;
            if (state.pros.length) text += `‚úÖ Pros: ${state.pros.slice(0,3).join(', ')}\n`;
            if (state.cons.length) text += `‚ùå Cons: ${state.cons.slice(0,2).join(', ')}\n`;
            text += '\n#TonyReviewsThings #Review';
            const ok = await copyTextWithFallback(text);
            showToast(ok ? 'Social copy ready' : 'Copy failed. Try manual copy.', ok ? 'success' : 'error');
        }

        function addItem(type) {
            const input = q(type === 'pro' ? 'proInput' : 'conInput');
            const value = input.value.trim();
            if (!value) return;
            if (type === 'pro') state.pros.push(value); else state.cons.push(value);
            input.value = '';
            renderProsCons();
            updatePreview();
        }

        document.querySelectorAll('input, textarea, select').forEach((el) => el.addEventListener('input', updatePreview));
        document.querySelectorAll('input[name="rating"]').forEach((el) => el.addEventListener('change', updatePreview));

        q('addProBtn').addEventListener('click', () => addItem('pro'));
        q('addConBtn').addEventListener('click', () => addItem('con'));
        q('proInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem('pro'); });
        q('conInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem('con'); });

        q('aiBtn').addEventListener('click', generateSuggestions);
        q('copyBtn').addEventListener('click', copyReview);
        q('downloadTxtBtn').addEventListener('click', () => download(generateFullReview(), 'txt', 'text/plain'));
        q('downloadMdBtn').addEventListener('click', () => download(generateMarkdown(), 'md', 'text/markdown'));
        q('socialBtn').addEventListener('click', copyForSocial);
        q('loginBtn').addEventListener('click', login);
        q('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });

        renderProsCons();
        updatePreview();
        checkSession();
    </script>
</body>
</html>
